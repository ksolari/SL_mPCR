###map and index each sample
ml biology bwa
ml biology samtools
bwa mem -t 4 ../snowleopard-111120.FINAL.DC2.leoY.fasta sample1_R1_001.fastq.gz sample1_R2_001.fastq.gz | samtools view -bS - | samtools sort - > sample1_sorted.bam
samtools index sample1_sorted.bam

###calculate number of reads
samtools flagstat sample1_sorted.bam

###Filter reads with Mappging Quality of 0
samtools view -h -q 1 sample1_sorted.bam -o sample1_sorted_MQ1.bam
samtools index sample1_sorted_MQ1.bam

###calculate number of reads after filtering based on mapping quality
samtools flagstat sample1_sorted_MQ1.bam

###calculate the read depth for each SNP in each sample:
bedtools multicov -bams sample1_sorted_MQ1.bam sample2_sorted_MQ1.bam ....... -bed 144SNPs_1bp_FINAL_noheader.bed > SL_mPCR_amplicon_coverage_144SNPs_1bp_ALLsamples.txt

###Filter bam to only include the target amplicon regions
bedtools intersect -a sample1_sorted_MQ1.bam -b FullAmplicon_50bpEachSide_144SNPs.bed > sample1_sorted_MQ1_AmpliconOnly.bam

###Calculate the number of reads MQ1_AmpliconOnly bams:
samtools flagstat sample1_sorted_MQ1_AmpliconOnly.bam

###call SNPs in target SNP location and the bas pair before and after
ls *_MQ1.bam > SortedMq1BamList.txt
bcftools mpileup -A -a AD,DP -R 144SNPs_3bp_FINAL_noheader.bed -f ../../snowleopard-111120.FINAL.DC2.leoY.fasta -b SortedMq1BamList.txt  | bcftools call -m -Oz -o AllPakistan_AllZoo_calls_noDepthLimit_AD_DP_noV_MQ1_144FinalOnly3bp.vcf

####filter to only 144 target SNPs
vcftools --vcf AllPakistan_AllZoo_calls_noDepthLimit_AD_DP_noV_MQ1_144FinalOnly3bp.vcf --out AllPakistan_AllZoo_calls_noDepthLimit_AD_DP_noV_MQ1_144FinalOnly1bp --bed 144SNPs_1bp_FINAL.bed --recode

###filter based on read depth
vcftools --vcf AllPakistan_AllZoo_calls_noDepthLimit_AD_DP_noV_MQ1_144FinalOnly1bp_rename.vcf --out AllPakistan_AllZoo_calls_noDepthLimit_AD_DP_noV_MQ1_144FinalOnly1bp_rename_minDP6 --minDP  6 --recode

